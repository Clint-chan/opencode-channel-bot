# OpenCode Channel Bot - æ¶æ„æ–‡æ¡£

## ğŸ¯ é¡¹ç›®å®šä½

**ç”Ÿäº§çº§å¤šæ¸ é“ Bot ç³»ç»Ÿ**ï¼Œæ”¯æŒé€šè¿‡ä¸åŒæ¶ˆæ¯å¹³å°ï¼ˆTelegramã€Discordã€Slack ç­‰ï¼‰è¿œç¨‹æ§åˆ¶ OpenCode AI åŠ©æ‰‹ï¼Œå®ç°å¤šé¡¹ç›®ç®¡ç†ã€ä¼šè¯ç®¡ç†å’Œå®æ—¶è¿›åº¦è·Ÿè¸ªã€‚

---

## ğŸ—ï¸ åˆ†å±‚æ¶æ„

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Channel Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Telegram   â”‚  â”‚   Discord    â”‚  â”‚    Slack     â”‚  â”‚
â”‚  â”‚   Adapter    â”‚  â”‚   Adapter    â”‚  â”‚   Adapter    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Unified Bot Core                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Command Router & Handler                          â”‚ â”‚
â”‚  â”‚  - User Management                                 â”‚ â”‚
â”‚  â”‚  - Project Management                              â”‚ â”‚
â”‚  â”‚  - Session Management                              â”‚ â”‚
â”‚  â”‚  - Task Operations                                 â”‚ â”‚
â”‚  â”‚  - Message History                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Business Logic Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Project    â”‚  â”‚   Session    â”‚  â”‚     Task     â”‚  â”‚
â”‚  â”‚   Manager    â”‚  â”‚   Manager    â”‚  â”‚   Manager    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚   Message    â”‚                                       â”‚
â”‚  â”‚   Manager    â”‚                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Data Access Layer                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Database Manager + Repositories                   â”‚ â”‚
â”‚  â”‚  - UserRepository                                  â”‚ â”‚
â”‚  â”‚  - ProjectRepository                               â”‚ â”‚
â”‚  â”‚  - SessionRepository                               â”‚ â”‚
â”‚  â”‚  - TaskRepository                                  â”‚ â”‚
â”‚  â”‚  - MessageRepository                               â”‚ â”‚
â”‚  â”‚  - SessionStatsRepository                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  OpenCode Integration                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  OpenCode Client (HTTP + SSE)                      â”‚ â”‚
â”‚  â”‚  - Session Creation                                â”‚ â”‚
â”‚  â”‚  - Prompt Sending                                  â”‚ â”‚
â”‚  â”‚  - Real-time Event Streaming                       â”‚ â”‚
â”‚  â”‚  - Task Abortion                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Path Validator (Cross-platform)                   â”‚ â”‚
â”‚  â”‚  - Windows / WSL / Linux / macOS                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
opencode-channel-bot/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.js                      # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ config.js                    # é…ç½®ç®¡ç†ä¸éªŒè¯
â”‚   â”œâ”€â”€ opencode-client.js           # OpenCode API å®¢æˆ·ç«¯ï¼ˆSSE æ”¯æŒï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ database/                    # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”œâ”€â”€ db-manager.js            # æ•°æ®åº“ç®¡ç†å™¨ï¼ˆå¤–é”®ã€äº‹åŠ¡ï¼‰
â”‚   â”‚   â”œâ”€â”€ migrations.js            # æ•°æ®åº“è¿ç§»ï¼ˆ7 è¡¨è®¾è®¡ï¼‰
â”‚   â”‚   â””â”€â”€ repositories.js          # æ•°æ®ä»“åº“ï¼ˆCRUD + äº‹åŠ¡ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                        # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ bot-core.js              # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘åè°ƒå™¨
â”‚   â”‚   â”œâ”€â”€ project-manager.js       # å¤šé¡¹ç›®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ session-manager.js       # ä¼šè¯ç®¡ç†ï¼ˆæ™ºèƒ½å¤ç”¨ï¼‰
â”‚   â”‚   â”œâ”€â”€ task-manager.js          # ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚   â”‚   â”œâ”€â”€ message-manager.js       # æ¶ˆæ¯å†å²ç®¡ç†
â”‚   â”‚   â””â”€â”€ errors.js                # è‡ªå®šä¹‰é”™è¯¯ç±»
â”‚   â”‚
â”‚   â”œâ”€â”€ channels/                    # æ¸ é“é€‚é…å±‚
â”‚   â”‚   â”œâ”€â”€ base-adapter.js          # æ¸ é“é€‚é…å™¨åŸºç±»
â”‚   â”‚   â””â”€â”€ telegram-adapter.js      # Telegram å®ç°
â”‚   â”‚
â”‚   â””â”€â”€ opencode/                    # OpenCode é›†æˆ
â”‚       â””â”€â”€ path-validator.js        # è·¨å¹³å°è·¯å¾„éªŒè¯
â”‚
â”œâ”€â”€ data/                            # SQLite æ•°æ®åº“ç›®å½•
â”œâ”€â”€ package.json
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ .env.example
â”œâ”€â”€ README.md
â””â”€â”€ ARCHITECTURE.md
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 7 è¡¨è®¾è®¡

ç³»ç»Ÿä½¿ç”¨ 7 è¡¨è®¾è®¡ï¼Œæ”¯æŒå¤šç”¨æˆ·ã€å¤šé¡¹ç›®ã€å¤šä¼šè¯ï¼š

```sql
-- 1. ç”¨æˆ·è¡¨ï¼ˆæ”¯æŒå¤šæ¸ é“ï¼‰
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  channel TEXT NOT NULL,
  channel_user_id TEXT NOT NULL,
  username TEXT,
  display_name TEXT,
  created_at INTEGER DEFAULT (strftime('%s', 'now')),
  last_active_at INTEGER DEFAULT (strftime('%s', 'now')),
  UNIQUE(channel, channel_user_id)
);

-- 2. ç”¨æˆ·è®¾ç½®è¡¨
CREATE TABLE user_settings (
  user_id INTEGER PRIMARY KEY,
  current_project_id INTEGER,
  language TEXT DEFAULT 'en',
  timezone TEXT DEFAULT 'UTC',
  created_at INTEGER DEFAULT (strftime('%s', 'now')),
  updated_at INTEGER DEFAULT (strftime('%s', 'now')),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (current_project_id) REFERENCES projects(id) ON DELETE SET NULL
);

-- 3. é¡¹ç›®è¡¨
CREATE TABLE projects (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  name TEXT NOT NULL,
  path TEXT NOT NULL,
  description TEXT,
  created_at INTEGER DEFAULT (strftime('%s', 'now')),
  last_used_at INTEGER DEFAULT (strftime('%s', 'now')),
  UNIQUE(user_id, name),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 4. ä¼šè¯è¡¨
CREATE TABLE sessions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  project_id INTEGER NOT NULL,
  opencode_session_id TEXT NOT NULL,
  title TEXT,
  status TEXT DEFAULT 'active',
  created_at INTEGER DEFAULT (strftime('%s', 'now')),
  last_used_at INTEGER DEFAULT (strftime('%s', 'now')),
  closed_at INTEGER,
  UNIQUE(project_id, opencode_session_id),
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);

-- 5. ä»»åŠ¡è¡¨
CREATE TABLE tasks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id INTEGER NOT NULL,
  task_text TEXT NOT NULL,
  status TEXT DEFAULT 'pending',
  progress TEXT,
  result TEXT,
  error_message TEXT,
  telegram_message_id INTEGER,
  created_at INTEGER DEFAULT (strftime('%s', 'now')),
  started_at INTEGER,
  completed_at INTEGER,
  FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE
);

-- 6. æ¶ˆæ¯å†å²è¡¨
CREATE TABLE messages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id INTEGER NOT NULL,
  role TEXT NOT NULL,
  content TEXT NOT NULL,
  telegram_message_id INTEGER,
  created_at INTEGER DEFAULT (strftime('%s', 'now')),
  FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE
);

-- 7. ä¼šè¯ç»Ÿè®¡è¡¨
CREATE TABLE session_stats (
  session_id INTEGER PRIMARY KEY,
  total_tasks INTEGER DEFAULT 0,
  completed_tasks INTEGER DEFAULT 0,
  failed_tasks INTEGER DEFAULT 0,
  total_messages INTEGER DEFAULT 0,
  user_messages INTEGER DEFAULT 0,
  assistant_messages INTEGER DEFAULT 0,
  first_message_at INTEGER,
  last_message_at INTEGER,
  total_duration_seconds INTEGER DEFAULT 0,
  created_at INTEGER DEFAULT (strftime('%s', 'now')),
  updated_at INTEGER DEFAULT (strftime('%s', 'now')),
  FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE
);
```

### å…³é”®è®¾è®¡å†³ç­–

1. **å¤–é”®çº¦æŸ + CASCADE åˆ é™¤**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œåˆ é™¤é¡¹ç›®æ—¶è‡ªåŠ¨æ¸…ç†ç›¸å…³ä¼šè¯ã€ä»»åŠ¡ã€æ¶ˆæ¯
2. **UNIQUE çº¦æŸ**ï¼šé˜²æ­¢é‡å¤æ•°æ®ï¼ˆç”¨æˆ·ã€é¡¹ç›®åã€ä¼šè¯ IDï¼‰
3. **æ—¶é—´æˆ³**ï¼šæ‰€æœ‰è¡¨ä½¿ç”¨ Unix æ—¶é—´æˆ³ï¼ˆINTEGERï¼‰ï¼Œä¾¿äºè®¡ç®—å’Œæ’åº
4. **çŠ¶æ€å­—æ®µ**ï¼šä½¿ç”¨ TEXT å­˜å‚¨çŠ¶æ€ï¼Œä¾¿äºæ‰©å±•
5. **ç»Ÿè®¡è¡¨**ï¼šç¼“å­˜ä¼šè¯ç»Ÿè®¡ä¿¡æ¯ï¼Œé¿å…é¢‘ç¹èšåˆæŸ¥è¯¢

---

## ğŸ¨ æ¸ é“é€‚é…å™¨è®¾è®¡

### BaseChannelAdapter æ¥å£

æ‰€æœ‰æ¸ é“é€‚é…å™¨å¿…é¡»ç»§æ‰¿æ­¤åŸºç±»å¹¶å®ç°æŠ½è±¡æ–¹æ³•ï¼š

```javascript
export class BaseChannelAdapter {
  constructor(botCore) {
    this.botCore = botCore;
  }

  // ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ˆå¿…é¡»å®ç°ï¼‰
  async start() { throw new Error('Not implemented'); }
  async stop() { throw new Error('Not implemented'); }

  // æ¶ˆæ¯å‘é€æ–¹æ³•ï¼ˆå¿…é¡»å®ç°ï¼‰
  async sendMessage(chatId, text, options) { throw new Error('Not implemented'); }
  async editMessage(chatId, messageId, text, options) { throw new Error('Not implemented'); }

  // æ ¼å¼åŒ–æ–¹æ³•ï¼ˆå¿…é¡»å®ç°ï¼‰
  formatTaskCard(task, session, project) { throw new Error('Not implemented'); }
  formatProjectList(projects, currentProjectId) { throw new Error('Not implemented'); }
  formatSessionList(sessions) { throw new Error('Not implemented'); }
}
```

### å®ç°ç¤ºä¾‹ï¼šTelegramAdapter

```javascript
export class TelegramAdapter extends BaseChannelAdapter {
  constructor(botCore, config, opencodeClient) {
    super(botCore);
    this.config = config;
    this.bot = new Telegraf(config.telegram.botToken);
    this.opencode = opencodeClient;
  }

  async start() {
    // æ³¨å†Œå‘½ä»¤å¤„ç†å™¨
    this.bot.command('addproject', this.handleAddProject.bind(this));
    this.bot.command('projects', this.handleProjects.bind(this));
    this.bot.command('task', this.handleTask.bind(this));
    // ... æ›´å¤šå‘½ä»¤

    // å¯åŠ¨ Bot
    await this.bot.launch();
  }

  formatTaskCard(task, session, project) {
    // Telegram ç‰¹å®šçš„æ ¼å¼åŒ–é€»è¾‘
    const statusEmoji = {
      pending: 'â³',
      running: 'ğŸ”„',
      completed: 'âœ…',
      error: 'âŒ'
    };

    return {
      text: `${statusEmoji[task.status]} ä»»åŠ¡ #${task.id}\n` +
            `ğŸ“‚ é¡¹ç›®: ${project.name}\n` +
            `ğŸ“ ${task.task_text}\n` +
            `â±ï¸ ${new Date(task.created_at * 1000).toLocaleString()}`,
      reply_markup: {
        inline_keyboard: [[
          { text: 'ğŸ”„ åˆ·æ–°', callback_data: `refresh_${task.id}` },
          { text: 'âŒ ä¸­æ­¢', callback_data: `abort_${task.id}` }
        ]]
      }
    };
  }
}
```

---

## ğŸ”§ è·¨å¹³å°è·¯å¾„å¤„ç†

### PathValidator å®ç°

```javascript
export class PathValidator {
  static async validate(inputPath) {
    // 1. è§„èŒƒåŒ–è·¯å¾„
    let normalizedPath = inputPath.trim();

    // 2. WSL è·¯å¾„è½¬æ¢ï¼š/mnt/c/... â†’ C:/...
    if (process.platform === 'win32' && normalizedPath.startsWith('/mnt/')) {
      const match = normalizedPath.match(/^\/mnt\/([a-z])\/(.*)/i);
      if (match) {
        normalizedPath = `${match[1].toUpperCase()}:/${match[2]}`;
      }
    }

    // 3. Windows è·¯å¾„è½¬æ¢ï¼šC:\... â†’ C:/...
    if (process.platform === 'win32') {
      normalizedPath = normalizedPath.replace(/\\/g, '/');
    }

    // 4. å±•å¼€ ~ ä¸ºç”¨æˆ·ä¸»ç›®å½•
    if (normalizedPath.startsWith('~')) {
      normalizedPath = normalizedPath.replace('~', os.homedir());
    }

    // 5. è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
    normalizedPath = path.resolve(normalizedPath);

    // 6. éªŒè¯è·¯å¾„å­˜åœ¨
    if (!fs.existsSync(normalizedPath)) {
      throw new Error(`è·¯å¾„ä¸å­˜åœ¨: ${normalizedPath}`);
    }

    // 7. éªŒè¯æ˜¯ç›®å½•
    const stats = await fs.promises.stat(normalizedPath);
    if (!stats.isDirectory()) {
      throw new Error(`è·¯å¾„ä¸æ˜¯ç›®å½•: ${normalizedPath}`);
    }

    return normalizedPath;
  }

  static toWSLPath(windowsPath) {
    // C:/Users/... â†’ /mnt/c/Users/...
    const match = windowsPath.match(/^([A-Z]):(\/.*)/i);
    if (match) {
      return `/mnt/${match[1].toLowerCase()}${match[2]}`;
    }
    return windowsPath;
  }
}
```

### æ”¯æŒçš„è·¯å¾„æ ¼å¼

```
âœ… Windows:
  - C:/Users/username/project
  - C:\Users\username\project
  - D:/projects/myapp

âœ… WSL (åœ¨ Windows ç¯å¢ƒ):
  - /mnt/c/Users/username/project  â†’ è‡ªåŠ¨è½¬æ¢ä¸º C:/Users/username/project

âœ… Linux/Mac:
  - /home/username/project
  - /Users/username/project
  - ~/project  â†’ è‡ªåŠ¨å±•å¼€
```

---

## ğŸ”„ ä¼šè¯ç®¡ç†ç­–ç•¥

### æ™ºèƒ½ä¼šè¯å¤ç”¨ï¼ˆSmart Managementï¼‰

**é»˜è®¤è¡Œä¸º**ï¼šè‡ªåŠ¨å¤ç”¨æœ€è¿‘çš„æ´»è·ƒä¼šè¯

```javascript
async getOrCreateCurrentSession(userId, opencodeSessionId, title = null) {
  const project = this.projectManager.getCurrentProject(userId);
  if (!project) {
    throw new NoCurrentProjectError();
  }

  // 1. å°è¯•å¤ç”¨æœ€è¿‘çš„æ´»è·ƒä¼šè¯
  const recentSession = this.sessionManager.getMostRecentActiveSession(project.id);
  if (recentSession) {
    return recentSession;
  }

  // 2. æ²¡æœ‰æ´»è·ƒä¼šè¯ï¼Œåˆ›å»ºæ–°ä¼šè¯
  const session = this.sessionManager.findOrCreateSession(
    project.id,
    opencodeSessionId,
    title
  );

  return session;
}
```

### æ‰‹åŠ¨ä¼šè¯æ§åˆ¶

```
/new              # å¼ºåˆ¶åˆ›å»ºæ–°ä¼šè¯
/sessions         # åˆ—å‡ºæ‰€æœ‰ä¼šè¯
/history [æ•°é‡]   # æŸ¥çœ‹å¯¹è¯å†å²
```

---

## ğŸ“Š å®æ—¶è¿›åº¦è·Ÿè¸ª

### SSE äº‹ä»¶å¤„ç†æµç¨‹

```javascript
// 1. è®¢é˜… OpenCode äº‹ä»¶
setupEventSubscription(chatId, taskId) {
  this.opencode.subscribeToEvents((event) => {
    this.handleOpenCodeEvent(chatId, taskId, event);
  });
}

// 2. å¤„ç†äº‹ä»¶
async handleOpenCodeEvent(chatId, taskId, event) {
  const task = this.botCore.taskManager.getTask(taskId);
  if (!task) return;

  switch (event.type) {
    case 'session.idle':
      // ä»»åŠ¡å®Œæˆ
      await this.botCore.taskManager.updateTaskStatus(taskId, 'completed');
      await this.bot.telegram.sendMessage(chatId, 'âœ… ä»»åŠ¡å®Œæˆï¼');
      break;

    case 'session.error':
      // ä»»åŠ¡å¤±è´¥
      await this.botCore.taskManager.updateTaskStatus(
        taskId,
        'error',
        null,
        null,
        event.data.error
      );
      await this.bot.telegram.sendMessage(chatId, `âŒ ä»»åŠ¡å¤±è´¥: ${event.data.error}`);
      break;

    case 'session.status':
      // è¿›åº¦æ›´æ–°
      await this.botCore.taskManager.updateTaskStatus(
        taskId,
        'running',
        event.data.status
      );
      // æ›´æ–°ä»»åŠ¡å¡ç‰‡
      if (task.telegram_message_id) {
        await this.editTaskCard(chatId, task.telegram_message_id, task);
      }
      break;
  }
}
```

---

## ğŸš€ åŠŸèƒ½è·¯çº¿å›¾

### å·²å®Œæˆ âœ…
- [x] å¤šé¡¹ç›®ç®¡ç†ï¼ˆæ·»åŠ ã€åˆ—è¡¨ã€åˆ‡æ¢ï¼‰
- [x] æ™ºèƒ½ä¼šè¯å¤ç”¨
- [x] ä»»åŠ¡åˆ›å»ºå’Œæ‰§è¡Œ
- [x] å®æ—¶è¿›åº¦æ›´æ–°ï¼ˆSSEï¼‰
- [x] å¯¹è¯å†å²è®°å½•
- [x] ä¼šè¯ç»Ÿè®¡
- [x] è·¨å¹³å°è·¯å¾„æ”¯æŒï¼ˆWindows/WSL/Linux/Macï¼‰
- [x] äº‹åŠ¡ç®¡ç†å’Œæ•°æ®ä¸€è‡´æ€§
- [x] è‡ªå®šä¹‰é”™è¯¯å¤„ç†
- [x] UNIQUE çº¦æŸå†²çªå¤„ç†

### è®¡åˆ’ä¸­ ğŸ“‹
- [ ] Discord æ¸ é“æ”¯æŒ
- [ ] Slack æ¸ é“æ”¯æŒ
- [ ] æ‰‹åŠ¨ä¼šè¯åˆ‡æ¢ï¼ˆ/resumeï¼‰
- [ ] ä»»åŠ¡ä¼˜å…ˆçº§é˜Ÿåˆ—
- [ ] ä»»åŠ¡é‡è¯•æœºåˆ¶
- [ ] Web Dashboard
- [ ] å¤šç”¨æˆ·åä½œ
- [ ] æƒé™ç®¡ç†

---

## ğŸ“„ è®¸å¯è¯

MIT
